{% extends "base.html" %}
{% block content %}

<style>
    /* 1. LAYOUT DASAR & SECURITY */
    nav.navbar { display: none !important; }
    body { 
        padding-top: 0 !important; 
        background-color: #f4f6f9; 
        user-select: none; -webkit-user-select: none;
        overflow-x: hidden;
    }

    /* 2. HEADER UJIAN (Fixed Top) */
    .exam-header {
        height: 60px; background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1020; position: fixed; top: 0; left: 0; right: 0;
        display: flex; align-items: center; justify-content: space-between; padding: 0 1rem;
    }

    .exam-container { margin-top: 80px; margin-bottom: 100px; position: relative; z-index: 1; }

    /* 3. BOX JAWABAN */
    .input-hidden { position: absolute; left: -9999px; opacity: 0; }
    .pilihan-box {
        display: flex; align-items: center; padding: 15px 20px;
        border: 2px solid #e9ecef; border-radius: 12px;
        cursor: pointer; transition: all 0.2s ease-in-out;
        background: white; margin-bottom: 12px; font-weight: 500;
        color: #495057; position: relative;
    }
    .pilihan-box:hover { background-color: #f8f9fa; border-color: #adb5bd; }
    input:checked + .pilihan-box {
        background-color: #e7f1ff; color: #0d6efd;
        border-color: #0d6efd; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
        font-weight: bold;
    }

    /* 4. TOMBOL NAVIGASI */
    .btn-nomor {
        width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
        font-weight: bold; border: 1px solid #dee2e6; background: white; border-radius: 8px;
        font-size: 1.1rem; color: #6c757d; transition: all 0.2s;
    }
    .btn-nomor.active { border: 3px solid #0d6efd !important; color: #0d6efd !important; }
    .btn-nomor.dijawab { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
    .btn-nomor.ragu { background-color: #ffc107 !important; color: black !important; border-color: #ffc107 !important; }

    /* 5. OVERLAY SECURITY */
    .watermark-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none; overflow: hidden; opacity: 0.04;
        display: flex; flex-wrap: wrap; align-content: flex-start;
    }
    .watermark-item {
        width: 300px; height: 200px; display: flex; align-items: center; justify-content: center;
        transform: rotate(-15deg); font-weight: 900; font-size: 1.2rem; color: #000; text-align: center;
    }
    .overlay-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 9999; display: flex; flex-direction: column;
        align-items: center; justify-content: center; text-align: center;
        backdrop-filter: blur(15px); padding: 20px;
    }
    #security-overlay { background: rgba(13, 110, 253, 0.98); color: white; }
    #warning-overlay { background: rgba(255, 193, 7, 0.98); color: #333; display: none; }
    #kick-overlay { background: rgba(220, 53, 69, 1); color: white; display: none; }
</style>

<div class="watermark-container">
    {% for i in range(30) %}
    <div class="watermark-item">
        {{ current_user.nama }}<br>{{ current_user.username }}<br>DILARANG CURANG
    </div>
    {% endfor %}
</div>

<div class="exam-header">
    <div class="lh-1">
        <h6 class="m-0 fw-bold text-primary text-truncate" style="max-width: 200px;">{{ ujian.judul }}</h6>
        <small class="text-muted">{{ ujian.mapel.nama }}</small>
    </div>
    <div class="d-flex align-items-center gap-2">
        <div class="badge bg-danger rounded-pill px-3 py-2 d-flex align-items-center shadow-sm">
            <i class="bi bi-clock-history me-1"></i>
            <span id="countdown" class="font-monospace fs-6">Memuat...</span>
        </div>
        <button class="btn btn-outline-secondary d-lg-none rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSoal" style="width: 40px; height: 40px;">
            <i class="bi bi-grid-3x3-gap-fill"></i>
        </button>
    </div>
</div>

<div id="security-overlay" class="overlay-screen">
    <i class="bi bi-shield-lock-fill display-1 mb-3"></i>
    <h2 class="fw-bold">Mode Ujian Aman</h2>
    <p class="px-4" style="max-width: 500px;">
        Sistem mendeteksi aktivitas layar.<br>
        <strong>JANGAN REFRESH HALAMAN ATAU KELUAR DARI APLIKASI!</strong>
    </p>
    <button onclick="startExam()" class="btn btn-light btn-lg text-primary fw-bold rounded-pill px-5 shadow mt-3">
        <i class="bi bi-play-fill"></i> MULAI UJIAN
    </button>
</div>

<div id="warning-overlay" class="overlay-screen">
    <div class="bg-white p-4 rounded-4 shadow-lg text-center" style="max-width: 400px; width: 90%;">
        <i class="bi bi-exclamation-triangle-fill text-warning display-1 mb-2"></i>
        <h3 class="fw-bold text-dark">Peringatan Sistem</h3>
        <p class="text-muted">Terdeteksi aktivitas mencurigakan (Keluar Aplikasi/Tab).</p>
        <hr>
        <div class="form-check text-start mb-3 bg-light p-3 rounded border">
            <input class="form-check-input" type="checkbox" id="janjiSiswa" onchange="toggleLanjutBtn()">
            <label class="form-check-label small fw-bold" for="janjiSiswa">
                Saya berjanji akan jujur dan tidak mengulangi lagi.
            </label>
        </div>
        <button id="btnLanjutWarning" onclick="resumeExam()" class="btn btn-warning w-100 fw-bold text-dark" disabled>
            Lanjutkan Ujian
        </button>
    </div>
</div>

<div id="kick-overlay" class="overlay-screen">
    <div class="spinner-border text-light mb-4" style="width: 3rem; height: 3rem;"></div>
    <h1 class="fw-bold display-5">DISKUALIFIKASI</h1>
    <p class="fs-4">Anda telah melewati batas toleransi.</p>
    <p class="text-white-50 small">Sistem sedang mengirim jawaban Anda...</p>
</div>


<div class="container exam-container">
    <form method="POST" id="formUjian">
        <input type="hidden" name="auto_submit_violation" value="false">

        <div class="row">
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-4">
                        
                        {% for s in pg_tampil %}
                        <div class="soal-step" id="step-{{ loop.index0 }}" data-type="pg">
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-primary">No. {{ loop.index }}</span>
                                <span class="badge bg-light text-dark border">Pilihan Ganda</span>
                            </div>
                            
                            {% if s.gambar %}
                            <div class="mb-4">
                                <img src="{{ url_for('static', filename='uploads/soal/' + s.gambar) }}" 
                                     class="img-fluid rounded border shadow-sm" 
                                     style="max-height: 400px; width: auto;" 
                                     alt="Gambar Soal">
                            </div>
                            {% endif %}

                            <div class="fs-5 mb-4 lh-base text-dark">{{ s.soal | safe }}</div>                            

                            <div class="opsi-wrapper">
                                {% for opt in s.opsi_acak %}
                                <div class="mb-2 position-relative">
                                    <input type="radio" 
                                           class="input-hidden input-jawaban-pg" 
                                           name="pg_{{ s.original_index }}" 
                                           id="opt_{{ s.original_index }}_{{ opt.kode }}" 
                                           value="{{ opt.kode }}" 
                                           data-nomor="{{ loop.index0 }}"
                                           onchange="savePG(this)">
                                    
                                    <label class="pilihan-box" for="opt_{{ s.original_index }}_{{ opt.kode }}">
                                        <span>{{ opt.teks }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        {% set start_essay = pg_tampil|length %}
                        {% for e in essay_tampil %}
                        <div class="soal-step" id="step-{{ start_essay + loop.index0 }}" data-type="essay">
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-success">No. {{ start_essay + loop.index }}</span>
                                <span class="badge bg-warning text-dark">Essay (Bobot: {{ e.bobot }})</span>
                            </div>
                                                        
                            {% if e.gambar %}
                            <div class="mb-4 text-center">
                                <img src="{{ url_for('static', filename='uploads/soal/' + e.gambar) }}" 
                                    class="img-fluid rounded border shadow-sm" 
                                    style="max-height: 400px; width: auto;">
                            </div>
                            {% endif %}

                            <div class="fs-5 mb-4 lh-base text-dark">{{ e.soal | safe }}</div>

                            <textarea name="essay_{{ e.original_index }}" 
                                      class="form-control bg-light input-jawaban-essay" rows="8" 
                                      placeholder="Ketik jawaban..." 
                                      data-nomor="{{ start_essay + loop.index0 }}"
                                      oninput="saveEssay(this)"></textarea>
                        </div>
                        {% endfor %}

                    </div>
                </div>
            </div>

            <div class="col-lg-3 d-none d-lg-block">
                <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 80px;">
                    <div class="card-header bg-white fw-bold text-center py-3">Navigasi Soal</div>
                    <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="row g-2">
                            {% set total = pg_tampil|length + essay_tampil|length %}
                            {% for i in range(total) %}
                            <div class="col-3">
                                <button type="button" class="btn btn-nomor" onclick="bukaSoal({{ i }})" id="nav-d-{{ i }}">{{ i + 1 }}</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom bg-white border-top py-2 px-3 shadow-lg d-flex justify-content-between align-items-center" style="z-index: 1030;">
            <button type="button" class="btn btn-outline-secondary px-3" id="btn-prev" onclick="gantiSoal(-1)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="form-check form-check-inline m-0 p-2 bg-warning bg-opacity-10 rounded border border-warning">
                <input class="form-check-input ms-1" type="checkbox" id="check-ragu" style="transform: scale(1.3);">
                <label class="form-check-label fw-bold text-warning ms-2" for="check-ragu">Ragu</label>
            </div>
            <button type="button" class="btn btn-primary px-4 fw-bold shadow-sm" id="btn-next" onclick="gantiSoal(1)">
                Lanjut <i class="bi bi-chevron-right"></i>
            </button>
            <button type="submit" class="btn btn-success px-4 fw-bold shadow-sm d-none" id="btn-submit"
                    onclick="return confirm('Yakin ingin menyelesaikan ujian?')">
                <i class="bi bi-send-fill me-1"></i> Kumpul
            </button>
        </div>
    </form>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasSoal">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title fw-bold">Daftar Soal</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body bg-light">
        <div class="row g-2">
            {% for i in range(total) %}
            <div class="col-3">
                <button type="button" class="btn btn-nomor" onclick="bukaSoal({{ i }})" id="nav-m-{{ i }}">{{ i + 1 }}</button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- VARIABLES & LOGIC ---
    const UJIAN_ID = "{{ ujian.id }}";
    const USER_ID = "{{ current_user.id }}";
    const BAN_KEY = `banned_${USER_ID}_${UJIAN_ID}`;
    const SAVE_PREFIX = `ans_${USER_ID}_${UJIAN_ID}_`;

    // --- NEW FLAG: Untuk menandai proses submit ---
    let isSubmitting = false; 

    let currentStep = 0;
    const totalStep = parseInt("{{ pg_tampil|length + essay_tampil|length }}");
    const steps = document.querySelectorAll('.soal-step');
    let sisaDetik = parseInt("{{ sisa_waktu_detik }}");

    let violationCount = 0;
    const MAX_VIOLATIONS = 3; 
    let isExamActive = false;
    let isWarningActive = false;

    // --- AUTO-SAVE & RESTORE ---
    function saveToLocal(name, value) { localStorage.setItem(SAVE_PREFIX + name, value); }
    function restoreAnswers() {
        const inputs = document.querySelectorAll('input[type="radio"], textarea');
        inputs.forEach(el => {
            const savedVal = localStorage.getItem(SAVE_PREFIX + el.name);
            if (savedVal) {
                if (el.type === 'radio') {
                    if (el.value === savedVal) { el.checked = true; markAnswered(el.dataset.nomor); }
                } else if (el.tagName === 'TEXTAREA') {
                    el.value = savedVal;
                    if(el.value.trim().length > 0) markAnswered(el.dataset.nomor);
                }
            }
        });
    }
    restoreAnswers();

    // --- LISTENER FORM SUBMIT ---
    // Mencegah deteksi pelanggaran saat tombol submit ditekan dan dikonfirmasi
    const formUjian = document.getElementById('formUjian');
    if (formUjian) {
        formUjian.addEventListener('submit', function() {
            isSubmitting = true; // Set flag menjadi true
        });
    }

    if (localStorage.getItem(BAN_KEY) === "true") { forceSubmitNow(); }

    function forceSubmitNow() {
        document.getElementById('security-overlay').style.display = 'none';
        document.getElementById('warning-overlay').style.display = 'none';
        document.getElementById('kick-overlay').style.display = 'flex';
        localStorage.setItem(BAN_KEY, "true");
        
        isSubmitting = true; // Hindari violation tambahan saat force submit
        setTimeout(() => { document.getElementById('formUjian').submit(); }, 500);
    }

    // --- NAVIGATION LOGIC ---
    function markAnswered(idx) {
        const d = document.getElementById(`nav-d-${idx}`);
        const m = document.getElementById(`nav-m-${idx}`);
        if(d) { d.classList.remove('ragu'); d.classList.add('dijawab'); }
        if(m) { m.classList.remove('ragu'); m.classList.add('dijawab'); }
    }
    function unmarkAnswered(idx) {
        const d = document.getElementById(`nav-d-${idx}`);
        const m = document.getElementById(`nav-m-${idx}`);
        if(d) d.classList.remove('dijawab');
        if(m) m.classList.remove('dijawab');
    }

    window.savePG = function(el) {
        saveToLocal(el.name, el.value);
        markAnswered(el.dataset.nomor);
        document.getElementById('check-ragu').checked = false;
    }
    window.saveEssay = function(el) {
        saveToLocal(el.name, el.value);
        if(el.value.trim().length > 0) {
            markAnswered(el.dataset.nomor);
            document.getElementById('check-ragu').checked = false;
        } else {
            unmarkAnswered(el.dataset.nomor);
        }
    }

    function updateUI() {
        steps.forEach(el => el.style.display = 'none');
        steps[currentStep].style.display = 'block';
        window.scrollTo(0, 0);

        document.getElementById('btn-prev').disabled = (currentStep === 0);
        const btnNext = document.getElementById('btn-next');
        const btnSubmit = document.getElementById('btn-submit');

        if (currentStep === totalStep - 1) {
            btnNext.classList.add('d-none');
            btnSubmit.classList.remove('d-none');
        } else {
            btnNext.classList.remove('d-none');
            btnSubmit.classList.add('d-none');
        }

        const btnNav = document.getElementById(`nav-d-${currentStep}`);
        document.getElementById('check-ragu').checked = btnNav.classList.contains('ragu');
        
        document.querySelectorAll('.btn-nomor').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-d-${currentStep}`).classList.add('active');
        document.getElementById(`nav-m-${currentStep}`).classList.add('active');
    }

    function gantiSoal(n) {
        if (n === 1 && currentStep >= totalStep - 1) return;
        if (n === -1 && currentStep <= 0) return;
        currentStep += n;
        updateUI();
    }
    
    function bukaSoal(n) {
        currentStep = n;
        updateUI();
        const bsOffcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasSoal'));
        if (bsOffcanvas) bsOffcanvas.hide();
    }

    document.getElementById('check-ragu').addEventListener('change', function() {
        const d = document.getElementById(`nav-d-${currentStep}`);
        const m = document.getElementById(`nav-m-${currentStep}`);
        if (this.checked) {
            if(d) { d.classList.remove('dijawab'); d.classList.add('ragu'); }
            if(m) { m.classList.remove('dijawab'); m.classList.add('ragu'); }
        } else {
            if(d) d.classList.remove('ragu'); 
            if(m) m.classList.remove('ragu');
            const step = steps[currentStep];
            if ((step.dataset.type === 'pg' && step.querySelector('input:checked')) || 
                (step.dataset.type === 'essay' && step.querySelector('textarea').value.trim() !== '')) {
                markAnswered(currentStep);
            }
        }
    });

    // --- TIMER & SECURITY ---
    const timerInterval = setInterval(() => {
        sisaDetik--;
        if (sisaDetik < 0) {
            clearInterval(timerInterval);
            document.getElementById('countdown').innerText = "HABIS";
            forceSubmitNow();
            return;
        }
        const h = Math.floor(sisaDetik / 3600);
        const m = Math.floor((sisaDetik % 3600) / 60);
        const s = Math.floor(sisaDetik % 60);
        document.getElementById('countdown').innerText = 
            `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
    }, 1000);

    window.startExam = function() { requestFullScreenAndRun(); }
    window.resumeExam = function() {
        document.getElementById('warning-overlay').style.display = 'none';
        isWarningActive = false;
        document.getElementById('janjiSiswa').checked = false;
        toggleLanjutBtn();
        requestFullScreenAndRun();
    }

    function requestFullScreenAndRun() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().then(() => {
                document.getElementById('security-overlay').style.display = 'none';
                isExamActive = true;
            }).catch(() => {
                document.getElementById('security-overlay').style.display = 'none';
                isExamActive = true;
            });
        } else {
            document.getElementById('security-overlay').style.display = 'none';
            isExamActive = true;
        }
    }

    window.toggleLanjutBtn = function() {
        document.getElementById('btnLanjutWarning').disabled = !document.getElementById('janjiSiswa').checked;
    }

    function recordViolation() {
        // --- CEK IS SUBMITTING DISINI ---
        // Jika sedang submit (isSubmitting = true), abaikan deteksi pelanggaran
        if (isWarningActive || isSubmitting) return; 
        
        violationCount++;
        if (violationCount >= MAX_VIOLATIONS) {
            forceSubmitNow();
        } else {
            isExamActive = false;
            isWarningActive = true;
            document.getElementById('warning-overlay').style.display = 'flex';
        }
    }

    document.addEventListener('visibilitychange', () => { if (document.hidden && isExamActive) recordViolation(); });
    window.addEventListener('blur', () => { 
        if (isExamActive && document.activeElement.tagName !== "IFRAME") {
             setTimeout(() => { if(!document.hasFocus()) recordViolation(); }, 500);
        }
    });
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && isExamActive && !isWarningActive) recordViolation();
    });
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if(e.keyCode == 123 || (e.ctrlKey && ['u','c','v','p','a','s'].includes(e.key)) || e.key === "PrintScreen") {
            e.preventDefault(); e.stopPropagation(); return false;
        }
    });

    updateUI();
</script>

{% endblock %}