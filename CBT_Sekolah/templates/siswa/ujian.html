{% extends "base.html" %}
{% block content %}

<style>
    /* =========================================
       1. LAYOUT & SECURITY BASE
       ========================================= */
    nav.navbar { display: none !important; } /* Sembunyikan Navbar Utama */
    
    body { 
        padding-top: 0 !important; 
        background-color: #f4f6f9; 
        user-select: none; -webkit-user-select: none; /* Anti Blok Teks */
        overflow-x: hidden;
        overscroll-behavior: none; /* Mencegah refresh tarik layar di HP */
    }

    /* Header Ujian Fixed di Atas */
    .exam-header {
        height: 60px; background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1020; position: fixed; top: 0; left: 0; right: 0;
        display: flex; align-items: center; justify-content: space-between; padding: 0 1rem;
    }

    .exam-container { margin-top: 80px; margin-bottom: 100px; position: relative; z-index: 1; }

    /* =========================================
       2. STYLING SOAL & OPSI
       ========================================= */
    .input-hidden { position: absolute; left: -9999px; opacity: 0; }
    
    .pilihan-box {
        display: flex; align-items: center; padding: 15px 20px;
        border: 2px solid #e9ecef; border-radius: 12px;
        cursor: pointer; transition: all 0.2s ease-in-out;
        background: white; margin-bottom: 12px; font-weight: 500;
        color: #495057; position: relative;
    }
    .pilihan-box:hover { background-color: #f8f9fa; border-color: #adb5bd; }
    
    /* Style saat Checked */
    input:checked + .pilihan-box {
        background-color: #e7f1ff; color: #0d6efd;
        border-color: #0d6efd; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
        font-weight: bold;
    }

    /* =========================================
       3. NAVIGASI NOMOR
       ========================================= */
    .btn-nomor {
        width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
        font-weight: bold; border: 1px solid #dee2e6; background: white; border-radius: 8px;
        font-size: 1.1rem; color: #6c757d; transition: all 0.2s; position: relative;
    }
    .btn-nomor.active { border: 3px solid #0d6efd !important; color: #0d6efd !important; z-index: 2; }
    .btn-nomor.dijawab { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
    .btn-nomor.ragu { background-color: #ffc107 !important; color: #212529 !important; border-color: #ffc107 !important; }

    /* =========================================
       4. OVERLAYS SECURITY (LAYAR PENUTUP)
       ========================================= */
    .watermark-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none; overflow: hidden; opacity: 0.04;
        display: flex; flex-wrap: wrap; align-content: flex-start;
    }
    .watermark-item {
        width: 300px; height: 200px; display: flex; align-items: center; justify-content: center;
        transform: rotate(-15deg); font-weight: 900; font-size: 1.2rem; color: #000; text-align: center;
    }

    .overlay-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 9999; display: flex; flex-direction: column;
        align-items: center; justify-content: center; text-align: center;
        backdrop-filter: blur(15px); padding: 20px;
    }

    /* Warna Overlay Berdasarkan Jenis */
    #security-overlay { background: rgba(13, 110, 253, 0.98); color: white; } /* BIRU (Intro) */
    #warning-overlay { background: rgba(255, 193, 7, 0.98); color: #333; display: none; } /* KUNING (Peringatan) */
    #kick-overlay { background: rgba(220, 53, 69, 1); color: white; display: none; } /* MERAH (Diskualifikasi) */
    
    /* OVERLAY SPLIT SCREEN (HITAM PEKAT & Z-INDEX TERTINGGI) */
    #split-overlay { 
        display: none; 
        background: #000 !important; 
        z-index: 2147483647 !important; /* Max Integer CSS */
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    }
</style>

<div class="watermark-container">
    {% for i in range(30) %}
    <div class="watermark-item">
        {{ current_user.nama }}<br>{{ current_user.username }}<br>DILARANG CURANG
    </div>
    {% endfor %}
</div>

<div class="exam-header">
    <div class="lh-1">
        <h6 class="m-0 fw-bold text-primary text-truncate" style="max-width: 200px;">{{ ujian.judul }}</h6>
        <small class="text-muted">{{ ujian.mapel.nama }}</small>
    </div>
    <div class="d-flex align-items-center gap-2">
        <div class="badge bg-danger rounded-pill px-3 py-2 d-flex align-items-center shadow-sm">
            <i class="bi bi-clock-history me-1"></i>
            <span id="countdown" class="font-monospace fs-6">Memuat...</span>
        </div>
        <button class="btn btn-outline-secondary d-lg-none rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSoal" style="width: 40px; height: 40px;">
            <i class="bi bi-grid-3x3-gap-fill"></i>
        </button>
    </div>
</div>

<div id="security-overlay" class="overlay-screen">
    <i class="bi bi-shield-lock-fill display-1 mb-3"></i>
    <h2 class="fw-bold">Mode Ujian Aman</h2>
    <p class="px-4" style="max-width: 500px;">
        Sistem mendeteksi aktivitas layar.<br>
        <strong>JANGAN KELUAR APLIKASI, SPLIT SCREEN, ATAU MEMBUKA POP-UP!</strong>
    </p>
    <button onclick="startExam()" class="btn btn-light btn-lg text-primary fw-bold rounded-pill px-5 shadow mt-3">
        <i class="bi bi-play-fill"></i> MULAI UJIAN
    </button>
</div>

<div id="warning-overlay" class="overlay-screen">
    <div class="bg-white p-4 rounded-4 shadow-lg text-center" style="max-width: 400px; width: 90%;">
        <i class="bi bi-exclamation-triangle-fill text-warning display-1 mb-2"></i>
        <h3 class="fw-bold text-dark">Peringatan Sistem</h3>
        <p class="text-muted">Terdeteksi aktivitas mencurigakan (Keluar Aplikasi/Tab).</p>
        <hr>
        <div class="form-check text-start mb-3 bg-light p-3 rounded border">
            <input class="form-check-input" type="checkbox" id="janjiSiswa" onchange="toggleLanjutBtn()">
            <label class="form-check-label small fw-bold" for="janjiSiswa">
                Saya berjanji akan jujur dan tidak mengulangi lagi.
            </label>
        </div>
        <button id="btnLanjutWarning" onclick="resumeExam()" class="btn btn-warning w-100 fw-bold text-dark" disabled>
            Lanjutkan Ujian
        </button>
    </div>
</div>

<div id="kick-overlay" class="overlay-screen">
    <div class="spinner-border text-light mb-4" style="width: 3rem; height: 3rem;"></div>
    <h1 class="fw-bold display-5">DISKUALIFIKASI</h1>
    <p class="fs-4">Anda telah melewati batas toleransi pelanggaran (3x).</p>
    <p class="text-white-50 small">Sistem sedang mengirim jawaban Anda...</p>
</div>

<div id="split-overlay" class="overlay-screen">
    <i class="bi bi-arrows-angle-contract text-danger display-1 mb-3"></i>
    <h2 class="fw-bold text-danger">DILARANG SPLIT SCREEN!</h2>
    <p class="text-white fs-5 px-3">
        Sistem mendeteksi ukuran layar tidak standar.<br>
        Kembalikan browser ke mode <strong>Layar Penuh (Full Screen)</strong> untuk melanjutkan.
    </p>
</div>

<div class="container exam-container">
    <form method="POST" id="formUjian">
        <input type="hidden" name="auto_submit_violation" value="false">

        <div class="row">
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-4">
                        
                        {% for s in pg_tampil %}
                        {% set q_key = s.id if s.id else s.original_index %}
                        <div class="soal-step" id="step-{{ loop.index0 }}" data-type="pg" data-key="{{ q_key }}"> 
                             
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-primary">No. {{ loop.index }}</span>
                                <span class="badge bg-light text-dark border">Pilihan Ganda</span>
                            </div>
                            
                            {% if s.gambar %}
                            <div class="mb-4 text-center">
                                <img src="{{ url_for('static', filename='uploads/soal/' + s.gambar) }}" 
                                     class="img-fluid rounded border shadow-sm" style="max-height: 400px;" alt="Gambar Soal">
                            </div>
                            {% endif %}

                            <div class="fs-5 mb-4 lh-base text-dark">{{ s.soal | safe }}</div>

                            <div class="opsi-wrapper">
                                {% for opt in s.opsi_acak %}
                                <div class="mb-2 position-relative">
                                    <input type="radio" class="input-hidden input-jawaban-pg" 
                                           name="pg_{{ q_key }}" id="opt_{{ s.original_index }}_{{ opt.kode }}" 
                                           value="{{ opt.kode }}" data-nomor="{{ loop.index0 }}" onchange="savePG(this)">
                                        
                                    <label class="pilihan-box d-block" for="opt_{{ s.original_index }}_{{ opt.kode }}">
                                        {% if opt.gambar %}
                                        <div class="mb-2">
                                            <img src="{{ url_for('static', filename='uploads/soal/' + opt.gambar) }}" 
                                                 class="img-fluid rounded border" style="max-height: 150px;">
                                        </div>
                                        {% endif %}
                                        <span class="d-flex"><span class="fw-bold me-2">{{ opt.kode }}.</span><span>{{ opt.teks }}</span></span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        {% set start_essay = pg_tampil|length %}
                        {% for e in essay_tampil %}
                        {% set q_key = e.id if e.id else e.original_index %}
                        <div class="soal-step" id="step-{{ start_essay + loop.index0 }}" data-type="essay" data-key="{{ q_key }}">
                             
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-success">No. {{ start_essay + loop.index }}</span>
                                <span class="badge bg-warning text-dark">Essay (Bobot: {{ e.bobot }})</span>
                            </div>
                            
                            {% if e.gambar %}
                            <div class="mb-4 text-center">
                                <img src="{{ url_for('static', filename='uploads/soal/' + e.gambar) }}" 
                                     class="img-fluid rounded border shadow-sm" style="max-height: 400px;">
                            </div>
                            {% endif %}
                            
                            <div class="fs-5 mb-4 lh-base text-dark">{{ e.soal | safe }}</div>
                            <textarea name="essay_{{ q_key }}" class="form-control bg-light input-jawaban-essay" 
                                      rows="8" placeholder="Ketik jawaban..." data-nomor="{{ start_essay + loop.index0 }}"
                                      oninput="saveEssay(this)"></textarea>
                        </div>
                        {% endfor %}

                    </div>
                </div>
            </div>

            <div class="col-lg-3 d-none d-lg-block">
                <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 80px;">
                    <div class="card-header bg-white fw-bold text-center py-3">Navigasi Soal</div>
                    <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="row g-2">
                            {% set total = pg_tampil|length + essay_tampil|length %}
                            {% for i in range(total) %}
                            <div class="col-3">
                                <button type="button" class="btn btn-nomor" onclick="bukaSoal({{ i }})" id="nav-d-{{ i }}">
                                    {{ i + 1 }}
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom bg-white border-top py-2 px-3 shadow-lg d-flex justify-content-between align-items-center" style="z-index: 1030;">
            <button type="button" class="btn btn-outline-secondary px-3" id="btn-prev" onclick="gantiSoal(-1)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="form-check form-check-inline m-0 p-2 bg-warning bg-opacity-10 rounded border border-warning">
                <input class="form-check-input ms-1" type="checkbox" id="check-ragu" style="transform: scale(1.3);">
                <label class="form-check-label fw-bold text-warning ms-2" for="check-ragu">Ragu</label>
            </div>
            <button type="button" class="btn btn-primary px-4 fw-bold shadow-sm" id="btn-next" onclick="gantiSoal(1)">
                Lanjut <i class="bi bi-chevron-right"></i>
            </button>
            <button type="submit" class="btn btn-success px-4 fw-bold shadow-sm d-none" id="btn-submit"
                    onclick="return confirm('Yakin ingin menyelesaikan ujian?')">
                <i class="bi bi-send-fill me-1"></i> Kumpul
            </button>
        </div>
    </form>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasSoal">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title fw-bold">Daftar Soal</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body bg-light">
        <div class="row g-2">
            {% for i in range(total) %}
            <div class="col-3">
                <button type="button" class="btn btn-nomor" onclick="bukaSoal({{ i }})" id="nav-m-{{ i }}">{{ i + 1 }}</button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI UTAMA ---
    const UJIAN_ID = "{{ ujian.id }}";
    const USER_ID = "{{ current_user.id }}";
    const BAN_KEY = `banned_${USER_ID}_${UJIAN_ID}`;
    const SAVE_PREFIX = `ans_${USER_ID}_${UJIAN_ID}_`;
    const RAGU_PREFIX = `ragu_${USER_ID}_${UJIAN_ID}_`; 
    
    // BATAS PELANGGARAN STRICT (3 KALI)
    const MAX_VIOLATIONS = 3; 
    let violationCount = 0;
    
    let isExamActive = false;
    let isWarningActive = false;
    let isSubmitting = false;
    
    let currentStep = 0;
    const totalStep = parseInt("{{ pg_tampil|length + essay_tampil|length }}");
    const steps = document.querySelectorAll('.soal-step');
    let sisaDetik = parseInt("{{ sisa_waktu_detik }}");

    // --- 1. WAKE LOCK (AGAR LAYAR TIDAK MATI) ---
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.error("Wake Lock Error:", err); }
    }

    // --- 2. ANTI SPLIT SCREEN (SMART KEYBOARD + BLACKOUT) ---
    function checkScreenDimension() {
        if (!isExamActive) return;

        // Ambil Ukuran Layar Fisik & Jendela Browser
        const screenW = window.screen.width;
        const screenH = window.screen.height;
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        // 1. Deteksi Lebar: Browser harus hampir Fullscreen (Toleransi 10%)
        // Jika lebar browser < 90% lebar layar, berarti Split Screen Kiri-Kanan
        const isNarrowWidth = winW < (screenW * 0.90);

        // 2. Deteksi Tinggi: Keyboard biasanya makan 30-40% layar. 
        // Jika sisa tinggi < 45%, itu mencurigakan (Split Screen Atas-Bawah)
        let isShortHeight = winH < (screenH * 0.45);

        // LOGIKA PENYELAMAT: Jika sedang ngetik, perubahan tinggi diizinkan
        const activeEl = document.activeElement;
        const isTyping = (activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'INPUT');
        if (isShortHeight && isTyping) {
            isShortHeight = false; // Batalkan deteksi split screen
        }

        const splitOverlay = document.getElementById('split-overlay');

        // EKSEKUSI BLOKIR: Jika terdeteksi sempit, tutup layar dengan hitam
        if (isNarrowWidth || isShortHeight) {
            if(splitOverlay.style.display === 'none') {
                splitOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Matikan scroll
            }
        } else {
            // JIKA AMAN: Buka kembali
            if(splitOverlay.style.display !== 'none') {
                splitOverlay.style.display = 'none';
                document.body.style.overflow = 'auto'; // Hidupkan scroll
            }
        }
    }
    window.addEventListener('resize', checkScreenDimension);
    setInterval(checkScreenDimension, 1000); // Cek rutin

    // --- 3. FUNGSI SUARA PERINGATAN ---
    function playWarningSound() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            osc.type = 'square';
            const now = ctx.currentTime;
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.linearRampToValueAtTime(1200, now + 0.25);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
            osc.start();
            osc.stop(now + 1.6); 
        } catch (e) { console.log("Audio Error"); }
    }

    // --- 4. NAVIGASI SOAL & LOCAL STORAGE ---
    function updateIndicatorStatus(idx) {
        const stepDiv = document.getElementById(`step-${idx}`);
        const navD = document.getElementById(`nav-d-${idx}`);
        const navM = document.getElementById(`nav-m-${idx}`);
        if (!stepDiv) return;

        const questionKey = stepDiv.getAttribute('data-key');
        let isAnswered = false;
        const type = stepDiv.getAttribute('data-type');

        if (type === 'pg') {
            if (stepDiv.querySelector('input[type="radio"]:checked')) isAnswered = true;
        } else if (type === 'essay') {
            if (stepDiv.querySelector('textarea').value.trim().length > 0) isAnswered = true;
        }

        const isRagu = localStorage.getItem(RAGU_PREFIX + questionKey) === 'true';

        if (navD) navD.className = 'btn btn-nomor';
        if (navM) navM.className = 'btn btn-nomor';

        if (idx === currentStep) {
            if(navD) navD.classList.add('active');
            if(navM) navM.classList.add('active');
        }

        if (isRagu) {
            if(navD) navD.classList.add('ragu');
            if(navM) navM.classList.add('ragu');
        } else if (isAnswered) {
            if(navD) navD.classList.add('dijawab');
            if(navM) navM.classList.add('dijawab');
        }
    }

    function saveToLocal(name, value) { localStorage.setItem(SAVE_PREFIX + name, value); }

    function restoreAnswers() {
        const inputs = document.querySelectorAll('input[type="radio"], textarea');
        inputs.forEach(el => {
            const savedVal = localStorage.getItem(SAVE_PREFIX + el.name);
            if (savedVal) {
                if (el.type === 'radio') {
                    if (el.value === savedVal) el.checked = true;
                } else if (el.tagName === 'TEXTAREA') {
                    el.value = savedVal;
                }
            }
        });
        for (let i = 0; i < totalStep; i++) updateIndicatorStatus(i);
    }

    window.savePG = function(el) {
        saveToLocal(el.name, el.value);
        const questionKey = el.name.replace('pg_', '');
        localStorage.setItem(RAGU_PREFIX + questionKey, 'false');
        document.getElementById('check-ragu').checked = false;
        updateIndicatorStatus(parseInt(el.dataset.nomor));
    }

    window.saveEssay = function(el) {
        saveToLocal(el.name, el.value);
        updateIndicatorStatus(parseInt(el.dataset.nomor));
    }

    document.getElementById('check-ragu').addEventListener('change', function() {
        const currentStepDiv = document.getElementById(`step-${currentStep}`);
        const questionKey = currentStepDiv.getAttribute('data-key');
        localStorage.setItem(RAGU_PREFIX + questionKey, this.checked);
        updateIndicatorStatus(currentStep);
    });

    function updateUI() {
        steps.forEach(el => el.style.display = 'none');
        steps[currentStep].style.display = 'block';
        window.scrollTo(0, 0);

        document.getElementById('btn-prev').disabled = (currentStep === 0);
        const btnNext = document.getElementById('btn-next');
        const btnSubmit = document.getElementById('btn-submit');

        if (currentStep === totalStep - 1) {
            btnNext.classList.add('d-none');
            btnSubmit.classList.remove('d-none');
        } else {
            btnNext.classList.remove('d-none');
            btnSubmit.classList.add('d-none');
        }

        const currentStepDiv = document.getElementById(`step-${currentStep}`);
        const questionKey = currentStepDiv.getAttribute('data-key');
        document.getElementById('check-ragu').checked = (localStorage.getItem(RAGU_PREFIX + questionKey) === 'true');
        for (let i = 0; i < totalStep; i++) updateIndicatorStatus(i);
    }

    function gantiSoal(n) {
        if (n === 1 && currentStep >= totalStep - 1) return;
        if (n === -1 && currentStep <= 0) return;
        currentStep += n;
        updateUI();
    }

    function bukaSoal(n) {
        currentStep = n;
        updateUI();
        const bsOffcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasSoal'));
        if (bsOffcanvas) bsOffcanvas.hide();
    }

    // --- 5. TIMER & SUBMIT ---
    const timerInterval = setInterval(() => {
        sisaDetik--;
        if (sisaDetik < 0) {
            clearInterval(timerInterval);
            document.getElementById('countdown').innerText = "HABIS";
            forceSubmitNow();
            return;
        }
        const h = Math.floor(sisaDetik / 3600);
        const m = Math.floor((sisaDetik % 3600) / 60);
        const s = Math.floor(sisaDetik % 60);
        document.getElementById('countdown').innerText = `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
    }, 1000);

    function forceSubmitNow() {
        document.getElementById('security-overlay').style.display = 'none';
        document.getElementById('warning-overlay').style.display = 'none';
        document.getElementById('kick-overlay').style.display = 'flex';
        document.getElementById('split-overlay').style.display = 'none'; // Matikan split overlay agar pesan DQ terlihat
        localStorage.setItem(BAN_KEY, "true");
        isSubmitting = true;
        setTimeout(() => { document.getElementById('formUjian').submit(); }, 500);
    }

    // --- 6. SECURITY LOGIC START/RESUME (THE CRITICAL FIX) ---

    // Fungsi Mulai Ujian (Awal)
    window.startExam = function() {
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch((e) => console.log(e));
        }
        document.getElementById('security-overlay').style.display = 'none';
        isExamActive = true;
        requestWakeLock();
    }

    // Fungsi Lanjutkan Ujian (Setelah Pelanggaran)
    window.resumeExam = function() {
        // [INSTANT FULLSCREEN FIX] Eksekusi Fullscreen di baris pertama
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch((err) => {
                console.log("Fullscreen Error:", err);
            });
        }
        
        // Reset Status
        document.getElementById('warning-overlay').style.display = 'none';
        isWarningActive = false;
        document.getElementById('janjiSiswa').checked = false;
        toggleLanjutBtn();
        isExamActive = true;
        requestWakeLock();
        
        // Cek lagi layar (jika masih split, langsung tutup lagi)
        setTimeout(checkScreenDimension, 500);
    }

    window.toggleLanjutBtn = function() {
        document.getElementById('btnLanjutWarning').disabled = !document.getElementById('janjiSiswa').checked;
    }

    // --- 7. DETEKTOR PELANGGARAN ---
    function recordViolation() {
        if (isWarningActive || isSubmitting) return; 
        
        playWarningSound();
        violationCount++;
        
        if (violationCount >= MAX_VIOLATIONS) {
            forceSubmitNow();
        } else {
            isExamActive = false;
            isWarningActive = true;
            document.getElementById('warning-overlay').style.display = 'flex';
        }
    }

    // EVENT LISTENER: BLUR (POP-UP/ALT-TAB)
    window.addEventListener('blur', () => { 
        if (document.activeElement.tagName === "IFRAME") return;
        
        if (isExamActive && !isWarningActive) {
             setTimeout(() => { 
                 if(!document.hasFocus()) {
                     console.log("Pelanggaran: Kehilangan Fokus (Blur)");
                     recordViolation(); 
                 }
             }, 500); // 500ms toleransi
        }
    });

    // EVENT LISTENER: VISIBILITY (TAB PINDAH)
    document.addEventListener('visibilitychange', () => { 
        if (document.hidden && isExamActive) recordViolation(); 
    });
    
    // EVENT LISTENER: KELUAR FULLSCREEN
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && isExamActive && !isWarningActive) {
            console.log("Pelanggaran: Keluar Fullscreen");
            recordViolation();
        }
    });

    // BLOKIR TOMBOL
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if(e.keyCode == 123 || (e.ctrlKey && ['u','c','v','p','a','s'].includes(e.key)) || e.key === "PrintScreen") {
            e.preventDefault(); e.stopPropagation(); return false;
        }
    });

    // INITIALIZATION
    restoreAnswers();
    updateUI();
    localStorage.removeItem(BAN_KEY);
</script>

{% endblock %}