{% extends "base.html" %}
{% block content %}

<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">{{ ujian.judul }}</h2>
            <p class="text-muted mb-0">
                {{ ujian.mapel.nama }} |
                {{ ujian.waktu_mulai.strftime('%d %b %Y') }}
            </p>
        </div>
        <div>
            <a href="/guru/dashboard" class="btn btn-secondary me-2">
                Kembali
            </a>

            <form method="POST" class="d-inline">
                <button type="submit" name="download_excel" value="1" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Download Excel
                </button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 bg-transparent">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-modern align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">No</th>
                            <th>Nama Siswa</th>
                            <th>Kelas</th>
                            <th class="text-center">Benar PG</th> <th class="text-center">Nilai PG</th>
                            <th class="text-center">Nilai Essay</th>
                            <th class="text-center">Total Akhir</th>
                            <th>Waktu Kumpul</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>

                    <tbody id="tbody-nilai"
                           hx-get="{{ url_for('guru.refresh_tabel_nilai', ujian_id=ujian.id) }}"
                           hx-trigger="every 10s"
                           hx-swap="innerHTML">
                        {% include 'guru/partials/tabel_nilai_body.html' %}
                    </tbody>

                </table>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modalResetGlobal" tabindex="-1">
  <div class="modal-dialog">
    <form id="reset-form" method="POST">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Reset Ujian Siswa</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Nama: <b id="reset-nama"></b></p>
          <p>Kelas: <b id="reset-kelas"></b></p>
          <div class="alert alert-warning small">
            PERHATIAN: Jawaban & nilai akan dihapus permanen. Siswa harus mengerjakan ulang.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-danger">Ya, Reset</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
function openReset(id, nama, kelas) {
    const form = document.getElementById('reset-form');
    form.action = "/guru/reset_peserta/" + id;
    document.getElementById('reset-nama').innerText = nama ?? '';
    document.getElementById('reset-kelas').innerText = kelas ?? '';

    const modalEl = document.getElementById('modalResetGlobal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    form.onsubmit = function(evt) {
        evt.preventDefault();
        fetch(form.action, { method: 'POST', credentials: 'same-origin' })
        .then(response => {
            if (response.status === 204) {
                modal.hide();
                if (window.htmx) {
                    htmx.trigger(document.getElementById('tbody-nilai'), 'refresh');
                } else {
                    location.reload();
                }
            } else {
                location.reload();
            }
        })
        .catch(err => {
            console.error(err);
            location.reload();
        });
        return false;
    };
}
</script>

{% endblock %}