{% extends "base.html" %}
{% block content %}

<style>
    /* CSS COUNTER AGAR NOMOR URUT OTOMATIS */
    #container-pg { counter-reset: counter-pg; }
    .item-pg { counter-increment: counter-pg; }
    .nomor-soal-pg::after { content: " " counter(counter-pg); }

    #container-essay { counter-reset: counter-essay; }
    .item-essay { counter-increment: counter-essay; }
    .nomor-soal-essay::after { content: " " counter(counter-essay); }

    /* STYLE OPSI VERTIKAL */
    .option-row {
        background-color: #f8f9fa;
        border-radius: 8px;
        transition: 0.2s;
        border: 1px solid #dee2e6;
    }
    .option-row:hover {
        background-color: #f1f3f5;
        border-color: #ced4da;
    }
    
    /* PREVIEW GAMBAR */
    .img-preview-box {
        background-color: #fff;
        padding: 10px;
        border: 1px dashed #ccc;
        border-radius: 6px;
        text-align: center;
        margin-bottom: 10px;
    }
    .img-preview-box img {
        max-width: 100%;
        max-height: 250px;
        object-fit: contain;
        border-radius: 4px;
    }

    /* RESPONSIVE & STICKY ACTION BAR */
    .indent-responsive { margin-left: 3rem !important; }

    @media (max-width: 576px) {
        .indent-responsive { margin-left: 0.5rem !important; }

        .mobile-sticky-action {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 12px 15px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            z-index: 1050;
            display: flex;
            gap: 10px;
            border-top: 1px solid #dee2e6;
        }

        body { padding-bottom: 80px; }
    }
</style>

<div class="container mt-4 mb-5">
    <form method="POST" enctype="multipart/form-data">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <div>
                <h2 class="mb-0 fw-bold fs-3">{{ ujian.judul }}</h2>
                <div class="text-muted small">
                    <i class="bi bi-book me-1"></i> {{ ujian.mapel.nama }} &bull;
                    <i class="bi bi-clock me-1"></i> {{ ujian.durasi_menit }} Menit
                </div>
            </div>

            <div class="d-none d-sm-flex gap-2">
                <a href="/guru/dashboard" class="btn btn-secondary px-4">Batal</a>
                <button type="submit" class="btn btn-primary px-4 fw-bold">
                    <i class="bi bi-save me-1"></i> Simpan Perubahan
                </button>
            </div>
        </div>

        <div class="mobile-sticky-action d-flex d-sm-none">
            <a href="/guru/dashboard" class="btn btn-outline-secondary flex-fill">Batal</a>
            <button type="submit" class="btn btn-primary flex-fill fw-bold shadow-sm">
                Simpan
            </button>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-light fw-bold">Pengaturan Umum</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Judul Ujian</label>
                        <input type="text" name="judul" value="{{ ujian.judul }}" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Durasi (Menit)</label>
                        <input type="number" name="durasi" value="{{ ujian.durasi_menit }}" class="form-control" required>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Waktu Mulai</label>
                        <input type="datetime-local" name="waktu_mulai"
                               value="{{ ujian.waktu_mulai.strftime('%Y-%m-%dT%H:%M') }}"
                               class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Waktu Selesai</label>
                        <input type="datetime-local" name="waktu_selesai"
                               value="{{ ujian.waktu_selesai.strftime('%Y-%m-%dT%H:%M') }}"
                               class="form-control" required>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                    <label class="small fw-bold text-warning">Timpa dengan Upload PDF Baru (Opsional)</label>
                    <input type="file" name="file_pdf" accept=".pdf" class="form-control form-control-sm">
                    <small class="text-muted fst-italic">Biarkan kosong jika hanya ingin mengedit manual di bawah ini.</small>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Soal Pilihan Ganda</span>
                <button type="button" class="btn btn-sm btn-light text-primary fw-bold" onclick="tambahPG()">
                    <i class="bi bi-plus-circle"></i> Tambah Soal
                </button>
            </div>
            <div class="card-body" id="container-pg">
                {% for s in pg_list %}
                {% set uid = s.id if s.id else loop.index0 %}
                
                <div class="border rounded p-3 mb-4 position-relative item-pg bg-white shadow-sm">
                    <input type="hidden" name="pg_id[]" value="{{ uid }}">

                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <div class="badge bg-primary fs-6 nomor-soal-pg">Soal No.</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch mb-0">
                                <input type="hidden" name="pg_img_status_{{ uid }}" id="status_pg_{{ uid }}" value="{{ '1' if s.gambar else '0' }}">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                       onchange="toggleImg(this, 'status_pg_{{ uid }}')" 
                                       {% if s.gambar %}checked{% endif %}>
                                <label class="form-check-label small fw-bold text-muted">Gambar Soal</label>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm px-3" onclick="hapusElemen(this)">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        </div>
                    </div>

                    <div class="img-container mb-3 p-3 border rounded bg-light {% if not s.gambar %}d-none{% endif %}">
                        {% if s.gambar %}
                        <div class="img-preview-box">
                            <label class="d-block small text-muted mb-1">Preview Gambar Saat Ini:</label>
                            <a href="{{ url_for('static', filename='uploads/soal/' + s.gambar) }}" target="_blank">
                                <img src="{{ url_for('static', filename='uploads/soal/' + s.gambar) }}" alt="Soal">
                            </a>
                        </div>
                        {% endif %}

                        <label class="small text-muted fw-bold mb-1">
                            {% if s.gambar %}Ganti Gambar Soal:{% else %}Upload Gambar Soal:{% endif %}
                        </label>
                        <input type="file" name="pg_img_{{ uid }}" class="form-control" accept="image/*">
                        <input type="hidden" name="pg_old_img_{{ uid }}" value="{{ s.gambar if s.gambar else '' }}">
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-secondary">Pertanyaan</label>
                        <textarea name="pg_soal[]" class="form-control" rows="2">{{ s.soal }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-secondary mb-2">Pilihan Jawaban</label>
                        {% for opt in ['a','b','c','d','e'] %}
                        <div class="option-row p-3 mb-3 position-relative">

                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2 fs-6" style="width: 35px;">{{ opt|upper }}</span>
                                <input type="text" name="pg_{{ opt }}[]" value="{{ s[opt] }}" class="form-control" placeholder="Teks jawaban opsi {{ opt|upper }}...">
                            </div>

                            <div class="form-check form-switch indent-responsive mb-2">
                                <input type="hidden" name="pg_img_status_{{ opt }}_{{ uid }}" id="status_pg_{{ opt }}_{{ uid }}" value="{{ '1' if s[opt + '_gambar'] else '0' }}">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                       onchange="toggleImg(this, 'status_pg_{{ opt }}_{{ uid }}')"
                                       {% if s[opt + '_gambar'] %}checked{% endif %}>
                                <label class="form-check-label small fw-bold text-muted">Sertakan Gambar</label>
                            </div>

                            <div class="opt-img-container indent-responsive p-2 border rounded bg-white {% if not s[opt + '_gambar'] %}d-none{% endif %}">

                                {% if s[opt + '_gambar'] %}
                                <div class="img-preview-box">
                                    <label class="d-block small text-muted mb-1">Gambar Opsi {{ opt|upper }} Saat Ini:</label>
                                    <a href="{{ url_for('static', filename='uploads/soal/' + s[opt + '_gambar']) }}" target="_blank">
                                        <img src="{{ url_for('static', filename='uploads/soal/' + s[opt + '_gambar']) }}">
                                    </a>
                                </div>
                                {% endif %}

                                <label class="small text-muted fw-bold mb-1">Upload / Ganti Gambar Opsi {{ opt|upper }}</label>
                                <input type="file" name="pg_img_{{ opt }}_{{ uid }}" class="form-control form-control-sm" accept="image/*">
                                <input type="hidden" name="pg_old_img_{{ opt }}_{{ uid }}" value="{{ s[opt + '_gambar'] if s[opt + '_gambar'] else '' }}">
                            </div>

                        </div>
                        {% endfor %}
                    </div>

                    <div>
                        <label class="fw-bold small text-success">Kunci Jawaban</label>
                        <select name="pg_kunci[]" class="form-select bg-success text-white fw-bold">
                            {% for k in ['A','B','C','D','E'] %}
                            <option value="{{ k }}" {% if s.kunci == k %}selected{% endif %}>Jawaban Benar: {{ k }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Soal Essay</span>
                <button type="button" class="btn btn-sm btn-light text-primary fw-bold" onclick="tambahEssay()">
                    <i class="bi bi-plus-circle"></i> Tambah Essay
                </button>
            </div>
            <div class="card-body" id="container-essay">
                {% for e in essay_list %}
                {% set uid = e.id if e.id else loop.index0 %}
                
                <div class="border rounded p-3 mb-4 position-relative item-essay bg-white shadow-sm">
                    <input type="hidden" name="essay_id[]" value="{{ uid }}">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <div class="badge bg-warning text-dark fs-6 nomor-soal-essay">Essay No.</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch mb-0">
                                <input type="hidden" name="essay_img_status_{{ uid }}" id="status_essay_{{ uid }}" value="{{ '1' if e.gambar else '0' }}">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                       onchange="toggleImg(this, 'status_essay_{{ uid }}')" 
                                       {% if e.gambar %}checked{% endif %}>
                                <label class="form-check-label small fw-bold text-muted">Gambar Soal</label>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm px-3" onclick="hapusElemen(this)">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-10">
                            <div class="img-container mb-3 p-3 border rounded bg-light {% if not e.gambar %}d-none{% endif %}">
                                {% if e.gambar %}
                                <div class="img-preview-box">
                                    <label class="d-block small text-muted mb-1">Preview Gambar:</label>
                                    <a href="{{ url_for('static', filename='uploads/soal/' + e.gambar) }}" target="_blank">
                                        <img src="{{ url_for('static', filename='uploads/soal/' + e.gambar) }}">
                                    </a>
                                </div>
                                {% endif %}

                                <label class="small text-muted fw-bold mb-1">Upload / Ganti Gambar</label>
                                <input type="file" name="essay_img_{{ uid }}" class="form-control" accept="image/*">
                                <input type="hidden" name="essay_old_img_{{ uid }}" value="{{ e.gambar if e.gambar else '' }}">
                            </div>

                            <label class="fw-bold small text-secondary">Pertanyaan Essay</label>
                            <textarea name="essay_soal[]" class="form-control mb-2" rows="3">{{ e.soal }}</textarea>
                        </div>
                        <div class="col-md-2 border-start">
                            <label class="fw-bold small text-secondary">Poin</label>
                            <input type="number" name="essay_bobot[]" value="{{ e.bobot }}" class="form-control mb-3 text-center fw-bold fs-5" required>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </form>
</div>

<script>
    function hapusElemen(btn) {
        if(confirm('Yakin ingin menghapus soal ini?')) {
            const item = btn.closest('.item-pg, .item-essay');
            if (item) item.remove();
        }
    }

    // Fungsi Toggle Gambar yang Lebih Kuat
    function toggleImg(checkbox, statusInputId) {
        const statusInput = document.getElementById(statusInputId);
        
        // Cari container gambar terdekat
        let container = null;
        if (checkbox.closest('.option-row')) {
            // Ini Opsi
            container = checkbox.closest('.option-row').querySelector('.opt-img-container');
        } else {
            // Ini Soal Utama (PG / Essay)
            container = checkbox.closest('.item-pg, .item-essay').querySelector('.img-container');
        }
        
        if(checkbox.checked) {
            if(container) container.classList.remove('d-none');
            if(statusInput) statusInput.value = '1'; // Set AKTIF
        } else {
            if(container) container.classList.add('d-none');
            if(statusInput) statusInput.value = '0'; // Set HAPUS
        }
    }

    // Helper: ID Unik Generator
    function generateUID() {
        return 'new_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    }

    // TAMBAH SOAL PG BARU
    function tambahPG() {
        const uid = generateUID();
        const html = `
        <div class="border rounded p-3 mb-4 position-relative item-pg bg-white shadow-sm">
            <input type="hidden" name="pg_id[]" value="${uid}">

            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <div class="badge bg-primary fs-6 nomor-soal-pg">Soal No.</div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0">
                        <input type="hidden" name="pg_img_status_${uid}" id="status_pg_${uid}" value="0">
                        <input class="form-check-input" type="checkbox" role="switch" onchange="toggleImg(this, 'status_pg_${uid}')">
                        <label class="form-check-label small fw-bold text-muted">Gambar Soal</label>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm px-3" onclick="hapusElemen(this)">
                        <i class="bi bi-trash"></i> Hapus
                    </button>
                </div>
            </div>

            <div class="img-container mb-3 p-3 border rounded bg-light d-none">
                <label class="small text-muted fw-bold mb-1">Upload Gambar Soal Baru</label>
                <input type="file" name="pg_img_${uid}" class="form-control" accept="image/*">
                <input type="hidden" name="pg_old_img_${uid}" value="">
            </div>

            <div class="mb-3">
                <label class="fw-bold small text-secondary">Pertanyaan Baru</label>
                <textarea name="pg_soal[]" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label class="fw-bold small text-secondary mb-2">Pilihan Jawaban</label>
                ${['a','b','c','d','e'].map(opt => `
                <div class="option-row p-3 mb-3 position-relative">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2 fs-6" style="width: 35px;">${opt.toUpperCase()}</span>
                        <input type="text" name="pg_${opt}[]" class="form-control" placeholder="Teks opsi ${opt.toUpperCase()}...">
                    </div>

                    <div class="form-check form-switch indent-responsive mb-2">
                        <input type="hidden" name="pg_img_status_${opt}_${uid}" id="status_pg_${opt}_${uid}" value="0">
                        <input class="form-check-input" type="checkbox" role="switch" onchange="toggleImg(this, 'status_pg_${opt}_${uid}')">
                        <label class="form-check-label small fw-bold text-muted">Sertakan Gambar</label>
                    </div>

                    <div class="opt-img-container indent-responsive p-2 border rounded bg-white d-none">
                        <label class="small text-muted fw-bold mb-1">Upload Gambar Opsi ${opt.toUpperCase()}</label>
                        <input type="file" name="pg_img_${opt}_${uid}" class="form-control form-control-sm" accept="image/*">
                        <input type="hidden" name="pg_old_img_${opt}_${uid}" value="">
                    </div>
                </div>`).join('')}
            </div>

            <div>
                <label class="fw-bold small text-success">Kunci Jawaban</label>
                <select name="pg_kunci[]" class="form-select bg-success text-white fw-bold">
                    <option value="A">Jawaban Benar: A</option>
                    <option value="B">Jawaban Benar: B</option>
                    <option value="C">Jawaban Benar: C</option>
                    <option value="D">Jawaban Benar: D</option>
                    <option value="E">Jawaban Benar: E</option>
                </select>
            </div>
        </div>`;
        document.getElementById('container-pg').insertAdjacentHTML('beforeend', html);
    }

    // TAMBAH SOAL ESSAY BARU
    function tambahEssay() {
        const uid = generateUID();
        const html = `
        <div class="border rounded p-3 mb-4 position-relative item-essay bg-white shadow-sm">
            <input type="hidden" name="essay_id[]" value="${uid}">

            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <div class="badge bg-warning text-dark fs-6 nomor-soal-essay">Essay No.</div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0">
                        <input type="hidden" name="essay_img_status_${uid}" id="status_essay_${uid}" value="0">
                        <input class="form-check-input" type="checkbox" role="switch" onchange="toggleImg(this, 'status_essay_${uid}')">
                        <label class="form-check-label small fw-bold text-muted">Gambar Soal</label>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm px-3" onclick="hapusElemen(this)">
                        <i class="bi bi-trash"></i> Hapus
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-10">
                    <div class="img-container mb-3 p-3 border rounded bg-light d-none">
                        <label class="small text-muted fw-bold mb-1">Upload Gambar Baru</label>
                        <input type="file" name="essay_img_${uid}" class="form-control" accept="image/*">
                        <input type="hidden" name="essay_old_img_${uid}" value="">
                    </div>

                    <label class="fw-bold small text-secondary">Pertanyaan Essay Baru</label>
                    <textarea name="essay_soal[]" class="form-control mb-2" rows="3"></textarea>
                </div>
                <div class="col-md-2 border-start">
                    <label class="fw-bold small text-secondary">Poin</label>
                    <input type="number" name="essay_bobot[]" value="10" class="form-control mb-3 text-center fw-bold fs-5" required>
                </div>
            </div>
        </div>`;
        document.getElementById('container-essay').insertAdjacentHTML('beforeend', html);
    }
</script>

{% endblock %}